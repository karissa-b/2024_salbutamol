---
title: "sleapdata_exp1_3"
author: ""
date: "2024-02-22"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  autodep = TRUE,
  echo = TRUE, 
  warning = FALSE,
  message = FALSE,
  fig.align = "center", 
  fig.retina = 1,
  out.width ="100%", 
  out.height = "100%"
)
```

```{r packages}
library(tidyverse)
library(readxl)
library(here)
library(magrittr)
library(scales)
library(readxl)
library(ggpubr)
library(ggeasy)
library(ggfortify)
library(ggbeeswarm)
library(ggforce)
library(ggrepel)
library(gganimate)
library(kableExtra)
library(pander)

# stat analysis
library(broom)
library(lme4)
library(performance)
library(car)
library(emmeans)
library(glmmTMB)
library(MASS)

# set the default theme for ggplot as theme_bw
theme_set(theme_classic())
```

# Introduction

I have used sleap.ai to predict the location of the head and tail base of each fish (x and y coordinates). Here, I will analyse these data to calculate:

-   distance traveled

-   time moving

-   active velocity

-   time in each zones

-   distance in each zones

-   zone changes

all files are read in, but I will just analyse one file from one fish for now.

```{r}
sleap_files <- list.files("data/exp1.3/sleap_data", 
           full.names = TRUE)

meta <- 
  readRDS("data/exp1.3/metadata_withGenotype.rds") %>% 
  dplyr::filter(genotype %in% c("het", "hom")) %>% 
    arrange(sex, genotype, treatment) %>% # for reordering factors later
  mutate(sex = case_when(
    grepl(sex, pattern = "m") ~ "m", 
    TRUE ~ sex
  ), 
  geno_treat = paste0(genotype, "_", treatment) %>% 
    as.factor() %>% 
    fct_inorder(),
  geno_treat_sex = paste0(genotype, "_", treatment,"_", sex) %>% 
    as.factor() %>% 
    fct_inorder(),
  .after = sex) 

data <- read_csv(sleap_files[2]) %>% 
  dplyr:::select(-track)

head(data) %>% 
  pander

```

Note that this video was originally recorded at 30 fps, but then written at 1 fps (i.e. skipping 29 frames.) So the `frame_idx` column means seconds. Note this may not be true for other videos read in at 30 fps

## plot some data

## head only

First look at how the fish head moves for the first 40 s. Increasing the number of frames means this video is bigger and goes faster.

```{r}
data %>% 
  dplyr::filter(frame_idx < 40) %>% 
  ggplot(aes(
    x = head.x, y = head.y, 
    colour = frame_idx 
  )) + 
  geom_point(
    size = 4
  ) + 
  transition_states(
    frame_idx, 
    transition_length = 2,
    state_length = 1) +
  shadow_trail(
    alpha = 0.3,
    max_frames = 10) +
  scale_x_continuous(limits = c(0, 200)) +
  scale_y_continuous(limits = c(0, 200)) +
  scale_color_viridis_c() 
```

## head and body

Now look at the head + body, and can have an arrow pointing in the direction of travel.

```{r}
data %>% 
  dplyr::filter(frame_idx < 40) %>% 
  ggplot() + 
   geom_segment(
     aes(xend = head.x, 
         yend = head.y, 
         x = tailbase.x, 
         y = tailbase.y, 
         colour = frame_idx), 
     arrow = arrow(length = unit(0.1,"cm")),
     size = 1
     ) +
  transition_states(
    frame_idx, 
    transition_length = 2,
    state_length = 1) +
  shadow_trail(
    alpha = 0.3,
    max_frames = 10) +
  scale_x_continuous(limits = c(0, 200)) +
  scale_y_continuous(limits = c(0, 200)) +
  scale_color_viridis_c() +
  labs(
    x = "x", 
    y = "y"
  )
```

## defining zones

I need to define the zones of the Y maze, as this is how I need to calculate the alternations.

I will first define the x.y. coordinates of the corners of the Ymaze, and use some trigonometry to define the zone 4 triangle.

```{r}
# define the corner/nodes of the Y shape 
x1 = 10
x2 = 25
x3 = 85
x4 = 105
x5 = 125
x6 = 185
x7 = 200

y1 = 10
y2 = 40
y3 = 50   
y4 = 85
y5 = 185

  
# Function to calculate area of a triangle
area <- function(x1, y1, x2, y2, x3, y3) {
  return(abs((x1 * (y2 - y3) + x2 * (y3 - y1) + x3 * (y1 - y2)) / 2))
}

# Function to check if a point is inside the triangle
is_inside <- function(x, y, x1, y1, x2, y2, x3, y3) {
  # Calculate area of the triangle
  triangle_area <- area(x1, y1, x2, y2, x3, y3)
  
  # Calculate areas of sub-triangles formed by point and each triangle vertex
  A1 <- area(x, y, x2, y2, x3, y3)
  A2 <- area(x1, y1, x, y, x3, y3)
  A3 <- area(x1, y1, x2, y2, x, y)
  
  # Check if sum of sub-triangle areas equals main triangle area
  return(abs(triangle_area - (A1 + A2 + A3)) < 1e-6)
}

# add a column defining the zone of each instance  
data %<>%
  mutate(
    # define the arms of the maze first 
    zone = case_when(
      head.y >= y4 & between(head.x, left = x3, right = x5)  ~ "1", 
      head.x >= x4 & between(head.y, left = y1, right = y4)  ~ "2", 
      head.x <= x4 & between(head.y, left = y1, right = y4)  ~ "3" 
    ), 
    # now define the central zone, overwriting the other zones if relevant 
    zone = case_when(
        is_inside(x = head.x, y = head.y, 
                x1 = x3, x2 = x5, x3 = x4, 
                y1 = y4, y2 = y4, y3 = y3) ~ "4" , 
        TRUE ~ zone
    ))
  
# Check this worked/ 
data %>% 
  dplyr::filter(!is.na(head.x)) %>% # omit instances where the head was not detected. 
  ggplot(aes(
    x = head.x, y = head.y, 
    colour = zone 
  )) + 
  geom_point(
    size = 4, 
    alpha = 0.5
  ) +
  theme_linedraw() +
  scale_x_continuous(
    limits = c(0,200), 
    breaks = seq(0, 200, by = 10)
  ) + 
    scale_y_continuous(
    limits = c(0,200), 
    breaks = seq(0, 200, by = 10)
  ) +
  theme(
    aspect.ratio = 1
  ) +
  scale_color_viridis_d()

```

# Assessing the score

There is an instance score associated with the instance, which represents how confident sleap was at finding the fish head and tail.

The instance score increases over the first few frames, then looks mostly uniform. My manual inspection of the videos showed it was very good at finding the fish so I will not omit any instances at this stage.

```{r}
data %>% 
  ggplot(aes(x = frame_idx, y = instance.score)) + 
  geom_point()
```

# Calculating distance traveled.

For this, I will just use the head x.y coordinates.

```{r}
distance.data <- 
  data %>% 
  dplyr::filter(!is.na(head.x)) %>% # omit the fish with no head coordinates
  mutate(
    dx = head.x - lag(head.x, n = 1),
    dy = head.y  - lag(head.y, n = 1)
  ) %>%
  # Calculate the distance using Pythagoras' theorem
  mutate(
    distance = sqrt(dx^2 + dy^2)
  )
  
distance.data %>% 
  dplyr::filter(frame_idx < 40) %>% 
  ggplot(aes(
    x = head.x, y = head.y, 
    colour = zone 
  )) + 
  geom_point(
    size = 4
  ) + 
  transition_states(
    frame_idx, 
    transition_length = 10,
    #wrap = T,
    state_length = 0.1) +
  shadow_trail(
    alpha = 0.3,
    max_frames = 10) +
  scale_x_continuous(limits = c(0, 200)) +
  scale_y_continuous(limits = c(0, 200)) +
  scale_color_viridis_d()
```

# All fish

## Import and cleaup data

Now I have an idea of how this data is processed, I will do for all fish. I first need to tidy-up all my names of the data and metadata to match so they can be joined.

```{r}
# recursively read in all csv files. 
data <- sleap_files %>% 
  sapply(function(x) {
    read_csv(x) %>% 
      dplyr:::select(-track)
  }, simplify = F)

# tidy up the names of the list
names(data) <- str_remove(names(data), 
                          pattern = "data/exp1.3/sleap_data/labels.v001.+_")
names(data) <- str_remove(names(data), 
                          pattern = ".analysis.csv")

# add the video_id number and y-maze position data to each element of the list so they can be joined to the metadaya
data %<>% map2(names(data), ~.x %>% mutate(video = .y))

# split the name and ymaze position into 2 separate columns
data %<>% 
  lapply(function(x) {x %>% 
      separate_wider_delim(cols = "video", delim = "-", names = c("video", "position"))
  })

# fix the videoFile column in the metadata
meta %<>% 
  mutate(
    # the video file 
    video = str_remove(videoFile, 
                       pattern = "YMaze_tracking.+-.+T") %>% 
      str_remove(pattern = "-f30.avi"), 
    # fix y-maze position so it is 0-based (like in python)
    position = as.numeric(ymazePosition) - 1, 
    position = as.character(position)
         )

# join the metadata to the tracking data
data %<>% 
  lapply(function(x) {
    x %>% 
      left_join(meta, by = c("position", "video"))
  })
```

### calculate zones

Since all the videos are technically the same, the same coordinates can be used for all videos.

```{r}
# define the corner/nodes of the Y shape 
x1 = 10
x2 = 25
x3 = 85
x4 = 105
x5 = 125
x6 = 185
x7 = 200

y1 = 10
y2 = 40
y3 = 50   
y4 = 85
y5 = 185

# Function to calculate area of a triangle
area <- function(x1, y1, x2, y2, x3, y3) {
  return(abs((x1 * (y2 - y3) + x2 * (y3 - y1) + x3 * (y1 - y2)) / 2))
}

# Function to check if a point is inside the triangle
is_inside <- function(x, y, x1, y1, x2, y2, x3, y3) {
  # Calculate area of the triangle
  triangle_area <- area(x1, y1, x2, y2, x3, y3)
  
  # Calculate areas of sub-triangles formed by point and each triangle vertex
  A1 <- area(x, y, x2, y2, x3, y3)
  A2 <- area(x1, y1, x, y, x3, y3)
  A3 <- area(x1, y1, x2, y2, x, y)
  
  # Check if sum of sub-triangle areas equals main triangle area
  return(abs(triangle_area - (A1 + A2 + A3)) < 1e-6)
}

# add a column defining the zone of each instance  
data %<>% 
  lapply(function(x) {
    x %>% 
      mutate(
        # define the arms of the maze first 
        zone = case_when(
          head.y >= y4 & between(head.x, left = x3, right = x5)  ~ "1", 
          head.x >= x4 & between(head.y, left = y1, right = y4)  ~ "2", 
          head.x <= x4 & between(head.y, left = y1, right = y4)  ~ "3" 
        ), 
        # now define the central zone, overwriting the other zones if relevant 
        zone = case_when(
          is_inside(x = head.x, y = head.y, 
                    x1 = x3, x2 = x5, x3 = x4, 
                    y1 = y4, y2 = y4, y3 = y3) ~ "4" , 
          TRUE ~ zone
        ))
  })
    
# Check this worke 
data %>% 
  bind_rows() %>% 
  dplyr::filter(!is.na(head.x)) %>% # omit instances where the head was not detected. 
  dplyr::filter(fish_id %in% 2:11) %>% 
  ggplot(aes(
    x = head.x, y = head.y, 
    colour = zone 
  )) + 
  geom_point(
    size = 4, 
    alpha = 0.5
  ) +
  theme_linedraw() +
  scale_x_continuous(
    limits = c(0,200), 
    breaks = seq(0, 200, by = 10)
  ) + 
    scale_y_continuous(
    limits = c(0,200), 
    breaks = seq(0, 200, by = 10)
  ) +
  theme(
    aspect.ratio = 1
  ) +
  scale_color_viridis_d() +
  facet_wrap(~fish_id)
```

### distance travelled

```{r}
data %<>% 
  lapply(function(x) {
    x %>% 
      dplyr::filter(!is.na(head.x)) %>% # omit the fish with no head coordinates
      mutate(
        dx = head.x - lag(head.x, n = 1),
        dy = head.y  - lag(head.y, n = 1)
      ) %>%
      # Calculate the distance using Pythagoras' theorem
      mutate(
        distance.pixels = sqrt(dx^2 + dy^2), 
        distance.cm = distance.pixels / 22.5 # based on 2 cm = 45 pixels
      )
  })

data %>% 
  bind_rows() %>% 
  ggplot(aes(x = frame_idx, y = distance.cm)) +
  geom_smooth(aes(group = geno_treat, colour = geno_treat))
```

### bins

Each frame represents 2 seconds in this experiment. This is a weird thing i did in caputing this data. next analyses should be careful to make sure the representation is right. Calculated that 6 bins should capture the whole hour.

```{r}
data %<>% 
  lapply(function(x) {
    x %>% 
      mutate(bin = ceiling(frame_idx / (120 * 10)), 
             bin = as.factor(bin))
  }) 
```

### setup the dataframe nicely

```{r}
data %<>% 
  lapply(function(x) {
    x %>% 
      dplyr::filter(frame_idx != 0) %>% 
      dplyr::select( # select rows of interest to the front 
        frame_idx, bin, fish_id, geno_treat,sex, distance.cm, zone, video, position, everything()
        )
  }) 
```

# Analysis of total distance travelled

## raw distance data: whole hour

I will first look at the total distance traveled in cm in an hour. No apparent differences between mutants.

```{r}
data %>% 
  bind_rows() %>% 
  group_by(fish_id) %>% # to calculate total distance travelled per fish. 
  mutate(
    total.dist.cm = sum(distance.cm), 
    .after = distance.cm # put it in a visisble location
    ) %>% 
  dplyr::distinct(fish_id, .keep_all = TRUE) %>% 
  ggplot(
    aes(x = treatment, y = total.dist.cm, colour = genotype)
    ) + 
  geom_jitter() +
  geom_boxplot() +
  facet_wrap(~sex)
```

## raw distance travelled: 10 minute bins

It is possible that the total distance travelled is the same, but perhaps the mutants behave differently across the hour in the test (e.g. different at the start v the end). This is not the case, and no stark differences are obsevred between the mutants.

```{r}
data %>% 
  bind_rows() %>% 
  group_by(bin, fish_id) %>% # to calculate total distance travelled per fish and bin.
  mutate(
    total.dist.cm = sum(distance.cm), 
    .after = distance.cm # put it in a visisble location
    ) %>% 
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  ggplot(
    aes(x = bin, y = total.dist.cm, colour = geno_treat)
    ) + 
  geom_jitter() +
  geom_boxplot() +
  facet_wrap(~sex+treatment)
```

## statistical test: linear mixed model

The total distance traveled per 10 minute data was fit to a linear mixed model. The effects of genotype, treatment, sex and bin were tested for statistical significance. However, no statistically significanct effect of genotype or treatment is is observed.

```{r}
# first, add the distnce data to the data object. 
data %<>% 
  bind_rows() %>% 
  group_by(bin, fish_id) %>% # to calculate total distance travelled per fish and bin.
  mutate(
    total.dist.cm.perbin = sum(distance.cm), 
    .after = distance.cm # put it in a visisble location
    ) 

fit.dists <- 
  data %>% 
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  lmer(total.dist.cm.perbin ~ genotype*treatment*bin*sex + (1|behavBatch) +(1|fish_id), 
       data = .)

# check model assumptions
# all look ok
# check_model(fit.dists)

# type II wald x2 test for statistical significnace of fixed effects
an <- Anova(fit.dists) %>% signif(2)

#emmeans(fit.dists, list(pairwise ~ genotype * treatment * sex), adjust = "tukey")

# geno treat sex
emmeans(fit.dists, ~ genotype * treatment * sex, type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = emmean, colour = genotype)) +
  geom_col(
    aes(fill = genotype), 
    alpha = 0.75,
    width = 0.75,
    position = position_dodge(width = 0.75)
  ) +
  geom_errorbar(
    aes(ymin =  lower.CL, ymax = upper.CL),
    width = 0.5, 
    position = position_dodge(width = 0.75)
    ) +
  facet_wrap(~sex, nrow = 1) + 
  scale_color_manual(values = c("grey50", "orangered")) +
  scale_fill_manual(values = c("grey50", "orangered")) +
  labs(
    title = "Total distance travelled per genotype, treatment and sex", 
    subtitle = paste0("p = ", an['genotype:treatment:sex','Pr(>Chisq)']), 
    y = "Model-predicted total distance travelled (cm)"
  )

# geno treat
print(emmeans(fit.dists, ~ genotype * treatment), type = "response") %>% 
  as_tibble() %>% 
  ggplot(
    aes(x = treatment, y = emmean/100, colour = genotype)
  ) +
  geom_col(
    aes(fill = genotype), 
    alpha = 0.75,
    position = position_dodge(width = 1)) +
  geom_errorbar(
    aes(ymin =  lower.CL/100, ymax = upper.CL/100),
    width = 0.5,
    size = 1,
    position = position_dodge(width = 1)
  ) +
  facet_wrap(~treatment, nrow = 1, scales = "free_x") +
  scale_color_manual(values = c("grey50", "orangered")) +
  scale_fill_manual(values = c("grey50", "orangered")) +
  labs(
    title = "Total distance travelled per genotype, treatment", 
    subtitle = paste0("p = ", an['genotype:treatment','Pr(>Chisq)']), 
    y = "Model-predicted total distance travelled (cm)"
  )


# geno treat bin
print(emmeans(fit.dists, ~ genotype * treatment * bin * sex), 
      type = "response") %>% 
  as_tibble() %>% 
  mutate(group = paste0(genotype, "_", 
                        treatment, "_", 
                        sex), 
         genotreat = paste0(genotype, "_", treatment)) %>% 
  dplyr::filter(genotreat != "het_20 µM Salbutamol") %>% 
  ggplot(aes(x = bin, y = emmean, colour = genotreat)) +
  geom_point(
    aes(fill =group), 
    alpha = 0.75,
    position = position_dodge(width = 0.75)
    ) +
  geom_errorbar(
    aes(ymin =  lower.CL, ymax = upper.CL),
    position = position_dodge(0.75)
    ) +
  geom_line(
    aes(group = group), 
    position = position_dodge(0.75),
    show.legend = F
    ) +
  facet_wrap(~sex, scales = "free_x") +
  scale_color_viridis_d(option = "turbo", end = 0.9) +
  scale_fill_viridis_d(option = "turbo", end = 0.9) +
  labs(
    title = "Total distance travelled per genotype, treatment, sex and bin ", 
    subtitle = paste0("p = ", an['genotype:treatment:bin:sex','Pr(>Chisq)']), 
    y = "Model-predicted total distance travelled (cm)"
  )
```

# Analysis of time spent moving

## raw data: whole hour

It is possible that while the distance traveled is not affected between mutant genotypes, but the time spent moving is. For example, the normal fish might have constant movement but the mutant fish might stop start.

I first need to define whether a fish is considered moving or not. After watching some of the videos, I will consider a fish moving if it moves more than 0.4 cm per frame (i.e. \> 0.2 cm/s)

```{r}
moving.threshold = 0.4
```

```{r}
data %>% 
  bind_rows() %>% 
  group_by(fish_id) %>% # to calculate time moving per fish. 
  mutate(
    moving = case_when(
      distance.cm < moving.threshold ~ FALSE, 
      distance.cm >= moving.threshold ~ TRUE, 
      TRUE ~ NA # all other vals make NA
    ),
    prop.moving.all = mean(moving == T), # calculate the proportion of time moving over the whole hour. 
    .after = distance.cm # put it in a visisble location
    ) %>% 
  
  dplyr::distinct(fish_id, .keep_all = TRUE) %>% 
  ggplot(
    aes(x = treatment, y = prop.moving.all, colour = genotype)
    ) + 
  geom_point(
   position = position_jitterdodge(dodge.width = 1)
    ) +
  geom_boxplot(
    position = position_dodge(width = 1),
    outlier.shape = NA, 
    fill = NA
    ) +
  scale_color_manual(values = c("grey50", "#d62906")) +
  facet_wrap(~sex)
```

## raw data: 10 minute bins

Like the distance travelled, the proportion of time spent moving could also change across the hour. Generally the fish spend less time moving in the final bin. But not much difference between genotypes.

```{r}
data %>% 
  bind_rows() %>% 
  group_by(bin, fish_id) %>% # to calculate total distance travelled per fish and bin.
  mutate(
    moving = case_when(
      distance.cm < moving.threshold ~ FALSE, 
      distance.cm >= moving.threshold ~ TRUE, 
      TRUE ~ NA # all other vals make NA
    ),
    prop.moving.bin = mean(moving == T), # calculate the proportion of time moving over the whole hour. 
    .after = distance.cm # put it in a visisble location
  ) %>% 
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  ggplot(
    aes(x = bin, y = prop.moving.bin, colour = geno_treat)
  ) + 
  geom_point(
    position = position_jitterdodge(dodge.width = 1)
  ) +
  geom_boxplot(
    position = position_dodge(width = 1),
    outlier.shape = NA, 
    fill = NA
  ) +
  facet_wrap(~sex+bin, scales = "free_x", nrow = 2)
```

## statistical test: generalised linear mixed model (beta-dist)

Proportion of time spend moving data was fitted to a generalised linear mixed model with a beta distribution and logit link function.

A statistically significant effect of treatment (and bin) was found, but not of genotype.

```{r}
# first add the prop.moving data to the object. 
data %<>% 
  bind_rows() %>% 
  group_by(bin, fish_id) %>% # to calculate total distance travelled per fish and bin.
  mutate(
    moving = case_when(
      distance.cm < moving.threshold ~ FALSE, 
      distance.cm >= moving.threshold ~ TRUE, 
      TRUE ~ NA # all other vals make NA
    ),
    prop.moving.bin = mean(moving == T), # calculate the proportion of time moving over the whole hour. 
    .after = distance.cm # put it in a visisble location
  ) 

fit.time.moving <- 
  data %>% 
  mutate( # adding a small number as beta dists cannot handle 0's
    prop.moving.bin = prop.moving.bin + 0.0000001 
  ) %>% 
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  glmmTMB(prop.moving.bin ~ genotype*treatment*bin*sex + (1|behavBatch) +(1|fish_id), 
       data = ., 
       family = beta_family(link="logit"))

# check model assumptions
# check_model(fit.time.moving)

# Type II Wald chisquare test of fixed effects
an.moving <- Anova(fit.time.moving) %>% signif(2)

# geno treat sex
emmeans(fit.time.moving, ~ genotype * treatment * sex, type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = response, colour = genotype)) +
  geom_col(
    aes(fill = genotype), 
    alpha = 0.75,
    width = 0.75,
    position = position_dodge(width = 0.75)
  ) +
  geom_errorbar(
    aes(ymin =  asymp.LCL, ymax = asymp.UCL),
    width = 0.5, 
    position = position_dodge(width = 0.75)
    ) +
  facet_wrap(~sex, nrow = 1) + 
  scale_color_manual(values = c("grey50", "orangered")) +
  scale_fill_manual(values = c("grey50", "orangered")) +
  labs(
    title = "Proportion of time-spent moving travelled per genotype, treatment and sex", 
    subtitle = paste0("p = ", an.moving['genotype:treatment:sex','Pr(>Chisq)']), 
    y = "Model-predicted proportion of time spent moving in Ymaze"
  )

# geno treat
emmeans(fit.time.moving, ~ genotype * treatment, type = "response") %>% 
  as_tibble() %>% 
  ggplot(
    aes(x = treatment, y = response, colour = genotype)
  ) +
  geom_col(
    aes(fill = genotype), 
    alpha = 0.75,
    position = position_dodge(width = 1)) +
  geom_errorbar(
    aes(ymin =  asymp.LCL, ymax = asymp.UCL),
    width = 0.5,
    size = 1,
    position = position_dodge(width = 1)
  ) +
  facet_wrap(~treatment, nrow = 1, scales = "free_x") +
  scale_color_manual(values = c("grey50", "orangered")) +
  scale_fill_manual(values = c("grey50", "orangered")) +
  labs(
    title = "Proportion of time-spent moving travelled per genotype, treatment", 
    subtitle = paste0("p = ", an.moving['genotype:treatment','Pr(>Chisq)']), 
    y = "Model-predicted proportion of time spent moving in Ymaze"
  )


# geno treat bin
emmeans(fit.time.moving, ~ genotype * treatment * bin * sex, 
      type = "response") %>% 
  as_tibble() %>% 
  mutate(group = paste0(genotype, "_", 
                        treatment, "_", 
                        sex), 
         genotreat = paste0(genotype, "_", treatment)) %>% 
  dplyr::filter(genotreat != "het_20 µM Salbutamol") %>% 
  ggplot(aes(x = bin, y = response, colour = genotreat)) +
  geom_point(
    aes(fill =group), 
    alpha = 0.75,
    position = position_dodge(width = 0.75)
    ) +
  geom_errorbar(
    aes(ymin =  asymp.LCL , ymax = asymp.UCL ),
    position = position_dodge(0.75)
    ) +
  geom_line(
    aes(group = group), 
    position = position_dodge(0.75),
    show.legend = F
    ) +
  scale_color_manual(values = c("grey70", "orangered", "green4")) +
  facet_wrap(~sex, scales = "free_x") +
  labs(
    title = "Average prop of spent moving travelled per genotype, treatment, sex and bin ", 
    subtitle = paste0("p = ", an.moving['genotype:treatment:bin:sex','Pr(>Chisq)']), 
    y = "Model-predicted proportion of time spent moving"
  )
```

# Analysis of active velocity

So now the question is when the mutants are moving, what is the average speed per ?

## raw data: average active velocity over the whole hour. 

Overall the active velocity seems very similar between groups. 

```{r}
data %>% 
  dplyr::filter(moving == TRUE) %>% # only look at the time when actually moving. 
  mutate(
    speed.cm.s = distance.cm/2, # distance travellled per second. 
    .after = distance.cm
  ) %>% 
  group_by(fish_id) %>% 
  mutate(
    ave.active.velovity.cms = mean(speed.cm.s), 
    .after = speed.cm.s
  ) %>% 
  dplyr::distinct(fish_id, .keep_all = T) %>% 
  ggplot(
    aes(x = treatment, y = ave.active.velovity.cms, colour = genotype)
  ) + 
  geom_jitter() +
  geom_boxplot() +
  facet_wrap(~sex) +
  scale_color_manual(values = c("grey70", "orangered"))
```

## raw data: 10 minute bins

The active velocity per fish also looks similar across groups when looking within 10 min bins. 

```{r}
data %>% 
  dplyr::filter(moving == T) %>% 
  group_by(fish_id) %>% # to calculate total distance travelled per fish and bin.
  mutate(
    speed.cm.s = distance.cm/2, # distance travellled per second. 
    .after = distance.cm
  ) %>% 
  group_by(fish_id, bin) %>% 
  mutate(
    ave.active.velovity.cms.perbin = mean(speed.cm.s), 
    .after = speed.cm.s
  ) %>% 
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  ggplot(
    aes(x = bin, y = ave.active.velovity.cms.perbin, colour = geno_treat)
    ) + 
  geom_jitter() +
  geom_boxplot() +
  facet_wrap(~sex+treatment)
```

## statistical test: linear mixed model

The average active velocity data per 10 mins was fit to a linear mixed model. The effects of genotype, treatment, sex and bin were tested for statistical significance. However, no statistically significanct effect of genotype or treatment is is observed.

```{r}
# first, add the active vel data to the data object. 
active.vel <- data %>% 
   group_by(fish_id) %>% # to calculate total distance travelled per fish and bin.
  mutate(
    speed.cm.s = distance.cm/2, # distance travellled per second. 
    .after = distance.cm
  ) %>% 
  dplyr::filter(moving == T) %>% 
  group_by(fish_id, bin) %>% 
  mutate(
    ave.active.velovity.cms.perbin = mean(speed.cm.s), 
    .after = speed.cm.s
  )

data %<>% 
  left_join(active.vel) 

# no longer need this. 
remove(active.vel)
  
fit.active.velocity <- 
  data %>% 
  dplyr::filter(moving == T) %>% 
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  lmer(ave.active.velovity.cms.perbin ~ genotype*treatment*bin*sex + (1|behavBatch) +(1|fish_id), 
       data = .)

# check model assumptions
# all look ok
# check_model(fit.active.velocity)

# type II wald x2 test for statistical significnace of fixed effects
an.activevel <- Anova(fit.active.velocity) %>% signif(2)

#emmeans(fit.dists, list(pairwise ~ genotype * treatment * sex), adjust = "tukey")

# geno treat sex
emmeans(fit.active.velocity, ~ genotype * treatment * sex, type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = emmean, colour = genotype)) +
  geom_col(
    aes(fill = genotype), 
    alpha = 0.75,
    width = 0.75,
    position = position_dodge(width = 0.75)
  ) +
  geom_errorbar(
    aes(ymin =  lower.CL, ymax = upper.CL),
    width = 0.5, 
    position = position_dodge(width = 0.75)
    ) +
  facet_wrap(~sex, nrow = 1) + 
  scale_color_manual(values = c("grey50", "orangered")) +
  scale_fill_manual(values = c("grey50", "orangered")) +
  labs(
    title = "TActive velocity", 
    subtitle = paste0("p = ", an.activevel['genotype:treatment:sex','Pr(>Chisq)']), 
    y = "Model-predicted active velocity (cm/s)"
  )


# geno treat bin
emmeans(fit.active.velocity, ~ genotype * treatment * bin * sex, 
      type = "response") %>% 
  as_tibble() %>% 
  mutate(group = paste0(genotype, "_", 
                        treatment, "_", 
                        sex), 
         genotreat = paste0(genotype, "_", treatment)) %>% 
  dplyr::filter(genotreat != "het_20 µM Salbutamol") %>% 
  ggplot(aes(x = bin, y = emmean, colour = genotreat)) +
  geom_point(
    aes(fill =group), 
    alpha = 0.75,
    position = position_dodge(width = 0.75)
    ) +
  geom_errorbar(
    aes(ymin =  lower.CL, ymax = upper.CL),
    position = position_dodge(0.75)
    ) +
  geom_line(
    aes(group = group), 
    position = position_dodge(0.75),
    show.legend = F
    ) +
  facet_wrap(~sex, scales = "free_x") +
  scale_color_viridis_d(option = "turbo", end = 0.9) +
  scale_fill_viridis_d(option = "turbo", end = 0.9) +
  labs(
    title = "Active velocity", 
    subtitle = paste0("p = ", an.activevel['genotype:treatment:bin:sex','Pr(>Chisq)']), 
    y = "Model-predicted total distance travelled (cm)"
  )
```

---
title: "sleapdata_exp1_3"
author: ""
date: "2024-02-22"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  autodep = TRUE,
  echo = TRUE, 
  warning = FALSE,
  message = FALSE,
  fig.align = "center", 
  fig.retina = 1,
  out.width ="100%", 
  out.height = "100%"
)
```

```{r packages}
library(tidyverse)
library(readxl)
library(here)
library(magrittr)
library(scales)
library(readxl)
library(ggpubr)
library(ggeasy)
library(ggfortify)
library(ggbeeswarm)
library(ggforce)
library(ggrepel)
library(gganimate)
library(kableExtra)
library(pander)

# stat analysis
library(broom)
library(lme4)
library(performance)
library(car)
library(emmeans)
library(glmmTMB)
library(MASS)

# set the default theme for ggplot as theme_bw
theme_set(theme_classic())
```

# Introduction

I have used sleap.ai to predict the location of the head and tail base of each fish (x and y coordinates). Here, I will analyse these data to calculate:

-   distance traveled

-   time moving

-   active velocity

-   time in each zones

-   distance in each zones

-   zone changes

all files are read in, but I will just analyse one file from one fish for now.

```{r}
sleap_files <- list.files("data/exp1.3/sleap_data", 
           full.names = TRUE)

meta <- readRDS("data/exp1.3/metadata_withGenotype.rds") %>% 
  dplyr::filter(genotype %in% c("het", "hom")) %>% 
  mutate(sex = case_when(
    grepl(sex, pattern = "m") ~ "m", 
    TRUE ~ sex
  ))

data <- read_csv(sleap_files[2]) %>% 
  dplyr:::select(-track)

head(data) %>% 
  pander

```

Note that this video was originally recorded at 30 fps, but then written at 1 fps (i.e. skipping 29 frames.) So the `frame_idx` column means seconds. Note this may not be true for other videos read in at 30 fps

## plot some data

## head only

First look at how the fish head moves for the first 40 s. Increasing the number of frames means this video is bigger and goes faster. 
```{r}
data %>% 
  dplyr::filter(frame_idx < 40) %>% 
  ggplot(aes(
    x = head.x, y = head.y, 
    colour = frame_idx 
  )) + 
  geom_point(
    size = 4
  ) + 
  transition_states(
    frame_idx, 
    transition_length = 2,
    state_length = 1) +
  shadow_trail(
    alpha = 0.3,
    max_frames = 10) +
  scale_x_continuous(limits = c(0, 200)) +
  scale_y_continuous(limits = c(0, 200)) +
  scale_color_viridis_c() 
```

## head and body

Now look at the head + body, and can have an arrow pointing in the direction of travel.
```{r}
data %>% 
  dplyr::filter(frame_idx < 40) %>% 
  ggplot() + 
   geom_segment(
     aes(xend = head.x, 
         yend = head.y, 
         x = tailbase.x, 
         y = tailbase.y, 
         colour = frame_idx), 
     arrow = arrow(length = unit(0.1,"cm")),
     size = 1
     ) +
  transition_states(
    frame_idx, 
    transition_length = 2,
    state_length = 1) +
  shadow_trail(
    alpha = 0.3,
    max_frames = 10) +
  scale_x_continuous(limits = c(0, 200)) +
  scale_y_continuous(limits = c(0, 200)) +
  scale_color_viridis_c() +
  labs(
    x = "x", 
    y = "y"
  )
```

## defining zones

I need to define the zones of the Y maze, as this is how I need to calculate the alternations. 

I will first define the x.y. coordinates of the corners of the Ymaze, and use some trigonometry to define the zone 4 triangle.

```{r}
# define the corner/nodes of the Y shape 
x1 = 10
x2 = 25
x3 = 85
x4 = 105
x5 = 125
x6 = 185
x7 = 200

y1 = 10
y2 = 40
y3 = 50   
y4 = 85
y5 = 185

  
# Function to calculate area of a triangle
area <- function(x1, y1, x2, y2, x3, y3) {
  return(abs((x1 * (y2 - y3) + x2 * (y3 - y1) + x3 * (y1 - y2)) / 2))
}

# Function to check if a point is inside the triangle
is_inside <- function(x, y, x1, y1, x2, y2, x3, y3) {
  # Calculate area of the triangle
  triangle_area <- area(x1, y1, x2, y2, x3, y3)
  
  # Calculate areas of sub-triangles formed by point and each triangle vertex
  A1 <- area(x, y, x2, y2, x3, y3)
  A2 <- area(x1, y1, x, y, x3, y3)
  A3 <- area(x1, y1, x2, y2, x, y)
  
  # Check if sum of sub-triangle areas equals main triangle area
  return(abs(triangle_area - (A1 + A2 + A3)) < 1e-6)
}

# add a column defining the zone of each instance  
data %<>%
  mutate(
    # define the arms of the maze first 
    zone = case_when(
      head.y >= y4 & between(head.x, left = x3, right = x5)  ~ "1", 
      head.x >= x4 & between(head.y, left = y1, right = y4)  ~ "2", 
      head.x <= x4 & between(head.y, left = y1, right = y4)  ~ "3" 
    ), 
    # now define the central zone, overwriting the other zones if relevant 
    zone = case_when(
        is_inside(x = head.x, y = head.y, 
                x1 = x3, x2 = x5, x3 = x4, 
                y1 = y4, y2 = y4, y3 = y3) ~ "4" , 
        TRUE ~ zone
    ))
  
# Check this worked/ 
data %>% 
  dplyr::filter(!is.na(head.x)) %>% # omit instances where the head was not detected. 
  ggplot(aes(
    x = head.x, y = head.y, 
    colour = zone 
  )) + 
  geom_point(
    size = 4, 
    alpha = 0.5
  ) +
  theme_linedraw() +
  scale_x_continuous(
    limits = c(0,200), 
    breaks = seq(0, 200, by = 10)
  ) + 
    scale_y_continuous(
    limits = c(0,200), 
    breaks = seq(0, 200, by = 10)
  ) +
  theme(
    aspect.ratio = 1
  ) +
  scale_color_viridis_d()

```

# Assessing the score

There is an instance score associated with the instance, which represents how confident sleap was at finding the fish head and tail. 

The instance score increases over the first few frames, then looks mostly uniform. My manual inspection of the videos showed it was very good at finding the fish so I will not omit any instances at this stage. 

```{r}
data %>% 
  ggplot(aes(x = frame_idx, y = instance.score)) + 
  geom_point()
```

# Calculating distance traveled.

For this, I will just use the head x.y coordinates.

```{r}
distance.data <- 
  data %>% 
  dplyr::filter(!is.na(head.x)) %>% # omit the fish with no head coordinates
  mutate(
    dx = head.x - lag(head.x, n = 1),
    dy = head.y  - lag(head.y, n = 1)
  ) %>%
  # Calculate the distance using Pythagoras' theorem
  mutate(
    distance = sqrt(dx^2 + dy^2)
  )
  
distance.data %>% 
  dplyr::filter(frame_idx < 40) %>% 
  ggplot(aes(
    x = head.x, y = head.y, 
    colour = zone 
  )) + 
  geom_point(
    size = 4
  ) + 
  transition_states(
    frame_idx, 
    transition_length = 10,
    #wrap = T,
    state_length = 0.1) +
  shadow_trail(
    alpha = 0.3,
    max_frames = 10) +
  scale_x_continuous(limits = c(0, 200)) +
  scale_y_continuous(limits = c(0, 200)) +
  scale_color_viridis_d()
```

# All fish

## Import and cleaup data
Now I have an idea of how this data is processed, I will do for all fish. I first need to tidy-up all my names of the data and metadata to match so they can be joined. 

```{r}
# recursively read in all csv files. 
data <- sleap_files %>% 
  sapply(function(x) {
    read_csv(x) %>% 
      dplyr:::select(-track)
  }, simplify = F)

# tidy up the names of the list
names(data) <- str_remove(names(data), 
                          pattern = "data/exp1.3/sleap_data/labels.v001.+_")
names(data) <- str_remove(names(data), 
                          pattern = ".analysis.csv")

# add the video_id number and y-maze position data to each element of the list so they can be joined to the metadaya
data %<>% map2(names(data), ~.x %>% mutate(video = .y))

# split the name and ymaze position into 2 separate columns
data %<>% 
  lapply(function(x) {x %>% 
      separate_wider_delim(cols = "video", delim = "-", names = c("video", "position"))
  })

# fix the videoFile column in the metadata
meta %<>% 
  mutate(
    # the video file 
    video = str_remove(videoFile, 
                       pattern = "YMaze_tracking.+-.+T") %>% 
      str_remove(pattern = "-f30.avi"), 
    # fix y-maze position so it is 0-based (like in python)
    position = as.numeric(ymazePosition) - 1, 
    position = as.character(position), 
    geno_treat = paste0(genotype, treatment)
         )

# join the metadata to the tracking data
data %<>% 
  lapply(function(x) {
    x %>% 
      left_join(meta, by = c("position", "video"))
  })
```

### calculate zones
Since all the videos are technically the same, the same coordinates can be used for all videos. 
```{r}
# define the corner/nodes of the Y shape 
x1 = 10
x2 = 25
x3 = 85
x4 = 105
x5 = 125
x6 = 185
x7 = 200

y1 = 10
y2 = 40
y3 = 50   
y4 = 85
y5 = 185

# Function to calculate area of a triangle
area <- function(x1, y1, x2, y2, x3, y3) {
  return(abs((x1 * (y2 - y3) + x2 * (y3 - y1) + x3 * (y1 - y2)) / 2))
}

# Function to check if a point is inside the triangle
is_inside <- function(x, y, x1, y1, x2, y2, x3, y3) {
  # Calculate area of the triangle
  triangle_area <- area(x1, y1, x2, y2, x3, y3)
  
  # Calculate areas of sub-triangles formed by point and each triangle vertex
  A1 <- area(x, y, x2, y2, x3, y3)
  A2 <- area(x1, y1, x, y, x3, y3)
  A3 <- area(x1, y1, x2, y2, x, y)
  
  # Check if sum of sub-triangle areas equals main triangle area
  return(abs(triangle_area - (A1 + A2 + A3)) < 1e-6)
}

# add a column defining the zone of each instance  
data %<>% 
  lapply(function(x) {
    x %>% 
      mutate(
        # define the arms of the maze first 
        zone = case_when(
          head.y >= y4 & between(head.x, left = x3, right = x5)  ~ "1", 
          head.x >= x4 & between(head.y, left = y1, right = y4)  ~ "2", 
          head.x <= x4 & between(head.y, left = y1, right = y4)  ~ "3" 
        ), 
        # now define the central zone, overwriting the other zones if relevant 
        zone = case_when(
          is_inside(x = head.x, y = head.y, 
                    x1 = x3, x2 = x5, x3 = x4, 
                    y1 = y4, y2 = y4, y3 = y3) ~ "4" , 
          TRUE ~ zone
        ))
  })
    
# Check this worke 
data %>% 
  bind_rows() %>% 
  dplyr::filter(!is.na(head.x)) %>% # omit instances where the head was not detected. 
  dplyr::filter(fish_id %in% 2:11) %>% 
  ggplot(aes(
    x = head.x, y = head.y, 
    colour = zone 
  )) + 
  geom_point(
    size = 4, 
    alpha = 0.5
  ) +
  theme_linedraw() +
  scale_x_continuous(
    limits = c(0,200), 
    breaks = seq(0, 200, by = 10)
  ) + 
    scale_y_continuous(
    limits = c(0,200), 
    breaks = seq(0, 200, by = 10)
  ) +
  theme(
    aspect.ratio = 1
  ) +
  scale_color_viridis_d() +
  facet_wrap(~fish_id)
```

### distance travelled 
```{r}
data %<>% 
  lapply(function(x) {
    x %>% 
      dplyr::filter(!is.na(head.x)) %>% # omit the fish with no head coordinates
      mutate(
        dx = head.x - lag(head.x, n = 1),
        dy = head.y  - lag(head.y, n = 1)
      ) %>%
      # Calculate the distance using Pythagoras' theorem
      mutate(
        distance.pixels = sqrt(dx^2 + dy^2), 
        distance.cm = distance.pixels / 22.5 # based on 2 cm = 45 pixels
      )
  })

data %>% 
  bind_rows() %>% 
  ggplot(aes(x = frame_idx, y = distance.cm)) +
  geom_smooth(aes(group = geno_treat, colour = geno_treat))
```

### bins 

Each frame represents 2 seconds in this experiment. This is a weird thing i did in caputing this data. next analyses should be careful to make sure the representation is right. Calculated that 6 bins should capture the whole hour. 
```{r}
data %<>% 
  lapply(function(x) {
    x %>% 
      mutate(bin = ceiling(frame_idx / (120 * 10)), 
             bin = as.factor(bin))
  }) 
```

### setup the dataframe nicely

```{r}
data %<>% 
  lapply(function(x) {
    x %>% 
      dplyr::filter(frame_idx != 0) %>% 
      dplyr::select( # select rows of interest to the front 
        frame_idx, bin, fish_id, genotype, treatment, distance.cm, zone, video, position, everything()
        )
  }) 
```


# Analysis of total distance travelled

## raw distance data: whole hour
I will first look at the total distance traveled in cm in an hour. No apparent differences between mutants. 

```{r}
data %>% 
  bind_rows() %>% 
  group_by(fish_id) %>% # to calculate total distance travelled per fish. 
  mutate(
    total.dist.cm = sum(distance.cm), 
    .after = distance.cm # put it in a visisble location
    ) %>% 
  dplyr::distinct(fish_id, .keep_all = TRUE) %>% 
  ggplot(
    aes(x = treatment, y = total.dist.cm, colour = genotype)
    ) + 
  geom_jitter() +
  geom_boxplot() +
  facet_wrap(~sex)
```

## raw distance travelled: 10 minute bins

It is possible that the total distance travelled is the same, but perhaps the mutants behave differently across the hour in the test (e.g. different at the start v the end).  This is not the case, and no stark differences are obsevred between the mutants. 

```{r}
data %>% 
  bind_rows() %>% 
  group_by(bin, fish_id) %>% # to calculate total distance travelled per fish and bin.
  mutate(
    total.dist.cm = sum(distance.cm), 
    .after = distance.cm # put it in a visisble location
    ) %>% 
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  ggplot(
    aes(x = bin, y = total.dist.cm, colour = geno_treat)
    ) + 
  geom_jitter() +
  geom_boxplot() +
  facet_wrap(~sex+treatment)
```

## statistical test 

The total distance traveled per 10 minute data was fit to a linear mixed model. The effects of genotype, treatment, sex and bin were tested for statistical significance. However, no effect of genotype is observed. 

```{r}
fit.dists <- 
  data %>% 
  bind_rows() %>% 
  group_by(bin, fish_id) %>% # to calculate total distance travelled per fish and bin.
  mutate(
    total.dist.cm = sum(distance.cm), 
    .after = distance.cm # put it in a visisble location
    ) %>%
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  lmer(total.dist.cm ~ genotype + treatment + bin + sex + (1|behavBatch) +(1|fish_id), 
       data = .)

# check assumptions
# all look ok
check_model(fit.dists)


an <- Anova(fit.dists)

emmeans(fit.dists, list(pairwise ~ genotype * treatment * sex), adjust = "tukey")

# geno treat sex
print(emmeans(fit.dists, ~ genotype * treatment * sex), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = emmean, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.75,
           width = 0.75,
           position = position_dodge(width = 0.75)) +
  geom_errorbar(aes(ymin =  lower.CL, ymax = upper.CL),
                width = 0.5, 
                position = position_dodge(width = 0.75)) +
  facet_wrap(~sex, nrow = 1)

# geno treat
print(emmeans(fit.dists, ~ genotype * treatment), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = emmean/100, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin =  lower.CL/100, ymax = upper.CL/100),
                position = position_dodge()) +
  facet_wrap(~treatment, nrow = 1, scales = "free_x") +
  labs(title = "7 days on salbutamol", 
       y = "Average distance travelled\nper 10 min bin (cm)") 

# geno treat bin
print(emmeans(fit.dists, ~ genotype * treatment * bin * sex), 
      type = "response") %>% 
  as_tibble() %>% 
  mutate(group = paste0(genotype, "_", 
                        treatment, "_", 
                        sex), 
         genotreat = paste0(genotype, "_", treatment)) %>% 
  dplyr::filter(genotreat != "het_20 µM Salbutamol") %>% 
  ggplot(aes(x = bin, y = emmean, colour = genotreat)) +
  geom_point(aes(fill =group), 
           alpha = 0.75,
           position = position_dodge(width = 0.75)) +
  geom_errorbar(aes(ymin =  lower.CL, ymax = upper.CL),
                position = position_dodge(0.75)) +
  geom_line(aes(group = group), 
            position = position_dodge(0.75),
            show.legend = F) +
  facet_wrap(~sex, 
             scales = "free_x")
```



